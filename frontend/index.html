<script>
  const API_BASE = window.API_BASE;

  async function API(path, params = {}) {
    const url = new URL(API_BASE + path);
    Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
    const r = await fetch(url);
    if (!r.ok) throw new Error(`API ${path} -> ${r.status}`);
    return r.json();
  }

  const makeSel = document.getElementById('make');
  const modelSel = document.getElementById('model');
  const yearSel  = document.getElementById('year');
  const trimSel  = document.getElementById('trim');
  const tmcEl    = document.getElementById('tmc');
  const tcEl     = document.getElementById('tc');

  const formatEUR = (n) =>
    n == null ? "—" : n.toLocaleString("fr-BE", { style: "currency", currency: "EUR" });

  async function init() {
    const makes = await API("/api/makes");
    makeSel.innerHTML = makes.map(m => `<option value="${m}">${m}</option>`).join('');
    modelSel.disabled = yearSel.disabled = trimSel.disabled = true;

    makeSel.addEventListener("change", onMake);
    modelSel.addEventListener("change", onModel);
    yearSel.addEventListener("change", onYear);
    trimSel.addEventListener("change", onTrim);
  }

  async function onMake() {
    const models = await API("/api/models", { make: makeSel.value });
    modelSel.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
    modelSel.disabled = false;
    yearSel.innerHTML = ""; yearSel.disabled = true;
    trimSel.innerHTML = ""; trimSel.disabled = true;
    tmcEl.textContent = tcEl.textContent = "—";
  }

  async function onModel() {
    const years = await API("/api/years", { make: makeSel.value, model: modelSel.value });
    yearSel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    yearSel.disabled = false;
    trimSel.innerHTML = ""; trimSel.disabled = true;
    tmcEl.textContent = tcEl.textContent = "—";
  }

  async function onYear() {
    const trims = await API("/api/engines", {
      make: makeSel.value,
      model: modelSel.value,
      year: yearSel.value
    });
    trimSel.innerHTML = trims.map(t =>
      `<option value="${t.trim_id}">${t.engine}</option>`
    ).join('');
    trimSel.disabled = false;
    tmcEl.textContent = tcEl.textContent = "—";
  }

  async function onTrim() {
    const q = await API("/api/quote", { trimId: trimSel.value });
    tmcEl.textContent = formatEUR(q.tmc);
    tcEl.textContent  = formatEUR(q.taxe_annuelle);
  }

  init();
</script>

